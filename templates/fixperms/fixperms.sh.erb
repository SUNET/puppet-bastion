#!/bin/bash

<% if @fixperms_paranoia %>
EXCLUDE_SUIDS=(/bin/su /sbin/unix_chkpwd /usr/bin/crontab /usr/bin/expiry /usr/bin/gpasswd /usr/bin/ssh-agent /usr/bin/sudo /usr/lib/openssh/ssh-keysign /usr/lib/pt_chown)
<% else %>
EXCLUDE_SUIDS=(/bin/mount /bin/ping /bin/ping6 /bin/su /bin/umount /sbin/mount.ecryptfs_private /sbin/unix_chkpwd /usr/bin/chage /usr/bin/chfn /usr/bin/chsh /usr/bin/crontab /usr/bin/dotlockfile /usr/bin/expiry /usr/bin/gpasswd /usr/bin/mail-lock /usr/bin/mail-touchlock /usr/bin/mail-unlock /usr/bin/ssh-agent /usr/bin/sudo /usr/bin/wall /usr/lib/openssh/ssh-keysign /usr/lib/pt_chown)
<% end %>

# Make index for faster matching later
declare -A EXCLUDE_SUID_INDEX
for i in "${EXCLUDE_SUIDS[@]}"; do
  EXCLUDE_SUID_INDEX[$i]=1
done


for p in <%= @fixperms_check_part.join(" ") %>; do
  # Remove SUID/GUID on files not matching exclude list
  for file in $(find $p -xdev -perm +0600 -type f -print); do
    if ! test $EXCLUDE_SUID_INDEX[$file]; then
      chmod -s $file
    fi
  done
  
  # Remove world writable files
  for entry in $(find $p -xdev \( -perm -0002 -a ! -perm 1000 \) \( -type f -o -type d \) -print); do
    chmod o-w $entry
  done
done
